{%- set func_name = "_" + app_name|ident -%}
{%- set scope = "" -%}

{#- macro def -#}
{%- macro argument_completion(argument) -%}
{% if argument.type == "select" -%}
if [ $cword -eq $COMP_CWORD ] ; then
  COMPREPLY=( $(compgen -W "{{ argument.options|join(" ") }}" -- "${COMP_WORDS[COMP_CWORD]}") )

  return 0
else
  cmd_cword=$(( cmd_cword + 1 ))
fi
{%- elif argument.type == "file" -%}
if [ $cword -eq $COMP_CWORD ] ; then
  {{ file_completion(argument.base_path or ".")|indent(2) }}

  return 0
else
  cmd_cword=$(( cmd_cword + 2 ))
fi
{%- elif argument.type == "command" -%}
if [ $cword -eq $COMP_CWORD ] ; then
  COMPREPLY=( $(compgen -W "$({{ argument.execute }})" -- "${COMP_WORDS[COMP_CWORD]}") )

  return 0
else
  cmd_cword=$(( cmd_cword + 2 ))
fi
{%- elif argument.type == "flag" -%}
cmd_cword=$(( cmd_cword + 1 ))
{%- endif -%}
{%- endmacro -%}

{#- macro def -#}
{%- macro command_completion(command, depth) -%}
cmd_cword=$cword
while [ $cword -lt $COMP_CWORD ] ; do
  cword=$(( cword + 1 ))

{%- if command.has_keyword_arguments %}
  case "${COMP_WORDS[cword-1]}" in
{%- for keyword, argument in command.keyword_arguments.items() %}
    {{ ([keyword] + argument.aliases)|join("|") }})
      {{ argument_completion(argument)|indent(6) }}
      ;;
{% endfor %}
    *)
      break
      ;;
  esac
{%- endif %}
done
{%- if command.has_positional_arguments %}
if [[ ! ${COMP_WORDS[COMP_CWORD]} == -* ]] ; then
  cword=$COMP_CWORD
  case $(( COMP_CWORD - cmd_cword + 1)) in
  {%- for position, argument in command.positional_arguments.items() %}
    {{ position }})
      {{ argument_completion(argument)|indent(4) }}
      ;;
  {% endfor -%}
  esac
fi
{%- endif %}

{% if command.type == "delegate" -%}
for ((i = 0; i < {{ depth }}; i++)); do
  for ((j = 0; j <= {{ "${#COMP_LINE}" }}; j++)); do
    [[ $COMP_LINE == "${COMP_WORDS[i]}"* ]] && break
    COMP_LINE=${COMP_LINE:1}
    ((COMP_POINT--))
  done
  COMP_LINE={{ '${COMP_LINE#"${COMP_WORDS[i]}"}' }}
  ((COMP_POINT -= {{ '${#COMP_WORDS[i]}' }}))
done
COMP_LINE="{{ command.targets | join(' ') }} $COMP_LINE"
COMP_POINT=$((COMP_POINT + {{ command.targets | join(" ") | length + 1 }}))
COMP_WORDS=({{ command.targets | join(" ") }} "${COMP_WORDS[{{ depth + 1 }}, -1]}")
COMP_CWORD={{ "${#COMP_WORDS[@]}" }}

[ -x "$(command -v _command_offset)" ] && _command_offset 0
{%- elif command.has_subcommands -%}
if [[ ${COMP_WORDS[COMP_CWORD]} == -* ]] ; then
  opts="{{ command.keyword_names_with_alias|join(' ') }}"
  COMPREPLY=( $(compgen -W "${opts}" -- "${COMP_WORDS[COMP_CWORD]}") )
  return 0
elif [ $cword -eq $COMP_CWORD ] ; then
  opts="{{ command.subcommand_names_with_alias|join(' ') }}"
  COMPREPLY=( $(compgen -W "${opts}" -- "${COMP_WORDS[COMP_CWORD]}") )
  return 0
fi
{%- elif command.has_positional_arguments or command.has_positional_wildcard_argument -%}
if [[ ${COMP_WORDS[COMP_CWORD]} == -* ]] ; then
  opts="{{ command.keyword_names_with_alias|join(' ') }}"
  COMPREPLY=( $(compgen -W "${opts}" -- "${COMP_WORDS[COMP_CWORD]}") )
  return 0
fi
{%- else -%}
opts="{{ command.keyword_names_with_alias|join(' ') }}"
COMPREPLY=( $(compgen -W "${opts}" -- "${COMP_WORDS[COMP_CWORD]}") )
{%- endif %}

{%- if command.has_positional_wildcard_argument %}
cword=$COMP_CWORD
{{ argument_completion(command.positional_wildcard_argument) }}
{%- endif %}
{%- endmacro -%}

{#- macro def -#}
{%- macro file_completion(base_path) -%}
dir="$(echo ${COMP_WORDS[COMP_CWORD]} | grep -o ".*/")"
if test "${dir}" ;then
    COMPREPLY=( $(compgen -W "$(ls -F "{{ base_path }}/${dir}" | sed -E "s@(.*)@${dir}\1@g")" -- "${COMP_WORDS[COMP_CWORD]}") )
else
    COMPREPLY=( $(compgen -W "$(ls -F "{{ base_path }}/")" -- "${COMP_WORDS[COMP_CWORD]}") )
fi
{%- endmacro -%}

#!/bin/bash
#
# Code generated by cmdcomp "{{ version }}". DO NOT EDIT.
# For more information about cmdcomp, please refer to https://github.com/yassun7010/cmdcomp .
#

{{ func_name }}() {
  local word cmd opts cword cmd_cword opts_cword
  COMPREPLY=()
  cmd=""
  opts=""
  cword=0
  cmd_cword=0
  opts_cword=0

  for word in ${COMP_WORDS[@]}; do
    case "${cmd},${word}" in
      ",$1")
        cmd="{{ func_name }}"
        cword=$(( cword + opts_cword + 1 ))
        ;;
{% for (tag, command_name), subcommand in append_key_tag(commands[app_name].subcommands, func_name).items() recursive %}
      {%- set new_tag = tag + "_" + command_name|ident %}
      {{ tag }},{{ command_name }}
{%- for alias in subcommand.aliases -%}
      |{{ tag }},{{ alias }}
{%- endfor -%})
        cmd="{{ new_tag }}"
        cword=$(( cword + opts_cword + 1 ))
        ;;
{{ loop(append_key_tag(subcommand.subcommands, new_tag).items()) -}}
{% endfor %}
      *)
        opts_cword=$(( opts_cword + 1 ))
        ;;
    esac
  done

  case "${cmd}" in
    {{ func_name }})
      {{ command_completion(commands[app_name], 1)|indent(6) }}

      return 0
      ;;
{% for (tag, command_name), subcommand in append_key_tag(commands[app_name].subcommands, func_name).items() recursive %}
{%- set new_tag = tag + "_" + command_name|ident %}
    {{ new_tag }})
      {{ command_completion(subcommand, loop.depth + 1)|indent(6) }}

      return 0
      ;;
{{ loop(append_key_tag(subcommand.subcommands, new_tag).items()) -}}
{% endfor %}
  esac
}

complete -F {{ func_name }} -o bashdefault -o default {{ app_name }}
{%- for alias in app_aliases %}
complete -F {{ func_name }} -o bashdefault -o default {{ alias }}
{%- endfor -%}
